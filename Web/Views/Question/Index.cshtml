
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!--问卷列表-->
<!--用bootstrap-table-->

<h3><i class="fa fa-angle-right"></i> 问卷列表</h3>
<div class="row mt">
    <div class="col-lg-12">
        <div class="content-panel">
            <section id="unseen" style="margin-left:10px;margin-right:10px;">


                <div id="toolbar" class="btn-group pull-right" style="margin-right: 20px;">
                    <button id="btn_add" type="button" class="btn btn-default" data-toggle='modal' data-target='#AddModal'>
                        <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>新增
                    </button>
                    <button id="btn_delete" type="button" class="btn btn-default" style="">
                        <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>删除
                    </button>
                   
                </div>
                <table id="naireList"></table>
            </section>
        </div><!-- /content-panel -->
    </div><!-- /col-lg-4 -->
</div><!-- /row -->
<!--修改时模态框-->
<div class="modal fade" id="EditModal" tabindex="-1" role="dialog" aria-labelledby="EditModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="EditModalLabel">修改问卷</h4>
            </div>
            <div class="modal-body">
                <form id="EditForm" class="form-horizontal style-form" method="post" action="##">
                    <div class="form-group hidden">
                        <label class="col-sm-2 col-sm-2 control-label">Id</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control round-form" id="EditId" name="EditId">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 col-sm-3 control-label">问卷标题</label>
                        <div class="col-sm-6">
                            <input type="text" class="form-control round-form" id="EditQuestionnaireName" name="EditQuestionnaireName">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 col-sm-3 control-label">问卷开始时间</label>
                        <div class="col-sm-6">
                            <input type="text" class="form-control round-form" id="EditStartTime" name="EditStartTime">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-3 col-sm-3 control-label">问卷结束时间</label>
                        <div class="col-sm-6">
                            <input class="form-control round-form" id="EditEndTime" name="EditEndTime">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 col-sm-3 control-label">学校</label>
                        <div class="col-sm-6">
                            <select class="form-control round-form" id="EditSchool" name="EditSchool"></select>
                        </div>
                    </div>
                    @*<div class="form-group">
                        <label class="col-sm-2 col-sm-2 control-label">老师</label>
                        <div class="col-sm-6">
                            <select type="text" class="form-control round-form" id="EditteacherName" name="EditteacherName"></select>
                        </div>
                    </div>*@
                    <div class="form-group">
                        <label class="col-sm-3 col-sm-3 control-label">调查班级</label>
                        <div class="col-sm-6">
                            <select type="text" class="form-control round-form" id="EditclassName" name="EditclassName"></select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal" id="EditClose">关闭</button>
                <button type="submit" class="btn btn-primary" id="EditSubmit">提交</button>
            </div>
        </div>
    </div>
</div>
<!--修改时模态框结束-->
<!--添加时模态框-->
<div class="modal fade" id="AddModal" tabindex="-1" role="dialog" aria-labelledby="EditModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="EditModalLabel">添加问卷</h4>
            </div>
            <div class="modal-body">
                <form id="EditForm" class="form-horizontal style-form" method="post" action="##">
                    <div class="form-group">
                        <label class="col-sm-3 col-sm-3 control-label">问卷标题</label>
                        <div class="col-sm-6">
                            <input type="text" class="form-control round-form" id="QuestionnaireName" name="QuestionnaireName">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 col-sm-3 control-label">问卷开始时间</label>
                        <div class="col-sm-6">
                            <input type="text" class="form-control round-form" id="StartTime" name="StartTime">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-3 col-sm-3 control-label">问卷结束时间</label>
                        <div class="col-sm-6">
                            <input class="form-control round-form" id="EndTime" name="EndTime">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 col-sm-3 control-label">学校</label>
                        <div class="col-sm-6">
                            <select class="form-control round-form" id="SchoolName" name="SchoolName"></select>
                        </div>
                    </div>
                    @*<div class="form-group">
                        <label class="col-sm-2 col-sm-2 control-label">老师</label>
                        <div class="col-sm-6">
                            <select class="form-control round-form" id="teacherName" name="teacherName"></select>
                        </div>
                    </div>*@

                    <div class="form-group">
                        <label class="col-sm-3 col-sm-3 control-label">调查班级</label>
                        <div class="col-sm-6">
                            <select type="text" class="form-control round-form" id="className" name="className"></select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal" id="AddClose">关闭</button>
                <button type="submit" class="btn btn-primary" id="AddSubmit">提交</button>
            </div>
        </div>
    </div>
</div>
<!--添加时模态框结束-->

@section javascript{


    <link href="~/assets/bootstraptable/src/bootstrap-table.css" rel="stylesheet" />
    <script src="~/assets/bootstraptable/src/bootstrap-table.js"></script>


    <script>

        $("#naireList").bootstrapTable({
            url: '/Question/GetNaireList',
            method: 'post',
            dataType: "json",
            // dataField: "data",

            classes: 'table',//边框
            undefinedText: '',//当数据为 undefined 时显示的字符
            pagination: true,//启动分页
            paginationLoop: true,
            pageNumber: 1,
            pageSize: 5,
            pageList: [1, 5, 10, 20],
            striped: true,
            showColumns: true,  //显示下拉框勾选要显示的列
            showRefresh: true,  //显示刷新按钮
            showToggle: true,//显示一行是否改成竖着
            showPaginationSwitch: true,//是否显示 下面的分页框
            search: true, //显示搜索框
            //toolbar操作
            toolbarAlign: 'left',//工具栏对齐方式
            buttonsAlign: 'right',//按钮对齐方式
            toolbar: '#toolbar',//指定工作栏


            //服务器端分页
            // queryParamsType: 'limit',//查询参数组织方式
            queryParamsType: "",
            queryParams: queryParams,//请求服务器时所传的参数
            sidePagination: 'server',//指定服务器端分页
            locale: 'zh-CN',//中文支持,
            // responseHandler:function(res){
            //在ajax获取到数据，渲染表格之前，修改数据源
            //   return res.rows;
            // },

            detailView: false,
            toolbal: '#toolbar',

            columns: [{
                    field: 'checkbox',
                    title: 'checkbox',
                    checkbox: true
                }, {
                    field: 'Id',  //真正序号隐藏
                    title: '序号',
                    sortable: true,
                    visible:false
                }, {
                    field: 'Ids',
                    title: '序号',
                    align: 'center',
                    formatter: function(value, row, index) {
                        var e = index+1;

                        return e;
                    }
                }, {
                    field: 'QuestionnaireName',
                    title: '问卷标题',
                    align: 'center',
                    sortable: true
                }, {
                    title: '操作',
                    field: 'caozuo',
                    align: 'center',
                    formatter: function(value, row, index) {
                        var e =
                            "<button class=\"btn btn-info btn-sm\" id = '" + row.Id + "' onclick=\"Edit(" + row.Id + ")\" data-toggle='modal' data-target='#EditModal'><span class='glyphicon glyphicon-pencil' aria-hidden='true' >修改</span></button>"
                                + "&nbsp&nbsp&nbsp<button class=\"btn btn-info btn-sm\" id = '" + row.Id + "' onclick=\"getQ(" + row.Id + ",\'" + row.QuestionnaireName + "\')\" ><span class='glyphicon glyphicon-pencil' aria-hidden='true'>增加问题</span></button>";
                        return e;
                    }
                }
            ],
        });

        //请求服务数据时所传参数

        function queryParams(params) {
            return {
                //每页多少条数据
                // pageSize: params.limit,
                //请求第几页
                // pageIndex: params.offset+1
                //Name: $('#search_name').val(),
                //Tel: $('#search_tel').val()

                pageSize: params.pageSize,
                pageIndex: params.pageNumber,

                keyWord: params.searchText
            }
        }



        $("#btn_delete").click(function() {

            var ids = $.map(
                $('#naireList').bootstrapTable('getSelections'),
                function(row) {
                    return row.Id;
                });
            //调用ajax，删除服务器端
            $.ajax({
                type: "POST",
                url: "/Question/Deletenaire",
                data: {
                    ids: ids
                },
                dataType: 'JSON',
                success: function (data) {
                    //显示删除成功
                    alert(data);
                    $("#naireList").bootstrapTable('refresh');

                }
            });

        });

    </script>

    <!--ajax提交添加学生信息-->
    <script>
    $("#btn_add").click(function () {
        $.ajax({
//获取学生学校信息
            async: false,
            url: "/Student/GetSchool",
            type: "POST",
            dataType: "JSON",
            success: function(school) {
                $("#SchoolName").empty();
                for (var i = 0; i < school.length; i++) {
                    if (i == 0) {
                        $("#SchoolName").append("<option value='" + school[i].Id + "' selected='selected'>" + school[i].SchoolName + "</option>")
                    } else {
                        $("#SchoolName").append("<option value='" + school[i].Id + "'>" + school[i].SchoolName + "</option>")
                    }

                }

                $.ajax({
                    //获取学生班级信息
                    async: false,
                    url: "/Student/GetClass",
                    data: { SchoolId: $('#SchoolName').val() },
                    type: "POST",
                    dataType: "JSON",
                    success: function(tempClass) {
                        $("#className").empty();
                        for (var i = 0; i < tempClass.length; i++) {
                            if (i == 0) {
                                $("#className").append("<option value='" + tempClass[i].Id + "' selected='selected'>" + tempClass[i].ClassName + "</option>")
                            } else {
                                $("#className").append("<option value='" + tempClass[i].Id + "'>" + tempClass[i].ClassName + "</option>")
                            }

                        }
                    }
                });

            }
        });
        $.ajax({
            //获取问卷老师信息
            async: false,
            url: "/Question/GetTeacher",
            data: { SchoolId: $('#SchoolName').val() },
            type: "POST",
            dataType: "JSON",
            success: function (teachersName) {
                $("#teacherName").empty();
                for (var i = 0; i < teachersName.length; i++) {
                    if (i == 0) {
                        $("#teacherName").append("<option value='" + teachersName[i].Id + "' selected='selected'>" + teachersName[i].TeacherName + "</option>");
                    } else {
                        $("#teacherName").append("<option value='" + teachersName[i].Id + "'>" + teachersName[i].TeacherName + "</option>");
                    }

                }
            }
        });

        //学校变更时班级信息变更
        $("#SchoolName").change(function() {
            var schoolId = $("#SchoolName").val();
            $.ajax({
                async: false,
                url: "/Student/GetClass?SchoolId = ",
                data: { schoolId: schoolId },
                type: "POST",
                dataType: "JSON",
                success: function(tempClass) {
                    $("#className").empty();
                    for (var i = 0; i < tempClass.length; i++) {
                        $("#className").append("<option value='" + tempClass[i].Id + "'>" + tempClass[i].ClassName + "</option>")
                    }
                }
            });
        });
        //学校变更时老师信息变更
        //$("#SchoolName").change(function () {
        //    var schoolId = $("#SchoolName").val();
        //    $.ajax({
        //        async: false,
        //        url: "/Question/GetTeacher?SchoolId = ",
        //        data: { schoolId: schoolId },
        //        type: "POST",
        //        dataType: "JSON",
        //        success: function (tempClass) {
        //            $("#teacherName").empty();
        //            for (var i = 0; i < tempClass.length; i++) {
        //                $("#teacherName").append("<option value='" + tempClass[i].Id + "'>" + tempClass[i].TeacherName + "</option>")
        //            }
        //        }
        //    });
        //});

    });

    //提交新建问卷信息
    $("#AddSubmit").click(function () {

        $.ajax({
            url: "/Question/AddSaveNaire",
            data: {
                QuestionnaireName: $("#QuestionnaireName").val(),
                StartTime: $("#StartTime").val(),
                EndTime: $("#EndTime").val(),
                SchoolName: $("#SchoolName").val(),
              //  teacherName: $("#teacherName").val(),
                className: $("#className").val(),
            },
            type: "POST",
            dataType: "json",
            success: function (result) {
                //$("#AddClose").click();
                alert(result);
                $('#AddModal').map(function () {
                    if (!$(this).is(":hidden")) {
                        $(this).modal('hide');
                    }


                });
                //$('#AddModal').on('hiddrn.bs.modal', '.modal', function () {
                //    $(this).removeData('bs.modal');
                //});
                $("#naireList").bootstrapTable('refresh');
            }
        });
    });
    </script>
    <!--ajax提交添加学生信息结束-->
    <!--增加问题-->
    <script>
        function getQ(Id,QuestionnaireName)
        {
            window.location.href = '/Question/AddNaireQuestions?Id=' + Id + '&QuestionnaireName=' + QuestionnaireName;
        }
    </script>
    <!--时间显示转换-->
    <script>
        function formatDate(dt) {
            var year = dt.getFullYear();
            var month = dt.getMonth() + 1;
            var date = dt.getDate();
            var hour = dt.getHours();
            var minute = dt.getMinutes();
            var second = dt.getSeconds();
            return year + "-" + month + "-" + date + " " + hour + ":" + minute + ":" + second;
        }
        function Test(time) {
            var t = time.slice(6, 19);
            var NewDtime = new Date(parseInt(t));
            return formatDate(NewDtime);
        }
    </script>


    <!--修改模态框处理-->
    <script>
    function Edit(Id) {

        $.ajax({
            type: "POST",

            url: "/Question/GetQuestionnaire",
            data: { Id: Id },

            dataType: "JSON",
            success: function (Question) {

                $("#EditId").val(Question.Id);
                $("#EditQuestionnaireName").val(Question.QuestionnaireName);
                $("#EditStartTime").val(Test(Question.StartTime));
                $("#EditEndTime").val(Test(Question.EndTime));
                $.ajax({
                    //获取学生学校信息
                    async: false,
                    url: "/Student/GetSchool",
                    type: "POST",
                    dataType: "JSON",
                    success: function (school) {
                        $("#EditSchool").empty();
                        for (var i = 0; i < school.length; i++) {
                            if (school[i].Id == Question.SchoolId) {
                                $("#EditSchool").append("<option value='" + school[i].Id + "' selected='selected'>" + school[i].SchoolName + "</option>");
                            } else {
                                $("#EditSchool").append("<option value='" + school[i].Id + "'>" + school[i].SchoolName + "</option>");
                            }

                        }

                    
                        $.ajax({
                            //获取学生班级信息
                            async: false,
                            url: "/Student/GetClass",
                            data: { SchoolId: $('#EditSchool').val() },
                            type: "POST",
                            dataType: "JSON",
                            success: function (tempClass) {
                                $("#EditclassName").empty();
                                for (var i = 0; i < tempClass.length; i++) {
                                    if (tempClass[i].Id == Question.ClassId) {
                                        $("#EditclassName").append("<option value='" + tempClass[i].Id + "' selected='selected'>" + tempClass[i].ClassName + "</option>");
                                    } else {
                                        $("#EditclassName").append("<option value='" + tempClass[i].Id + "'>" + tempClass[i].ClassName + "</option>");
                                    }

                                }
                            }
                        });

                    }
                });
                //$.ajax({
                //    //获取问卷老师信息
                //    async: false,
                //    url: "/Question/GetTeacher",
                //    data: { SchoolId: $('#EditSchool').val() },
                //    type: "POST",
                //    dataType: "JSON",
                //    success: function (teachersName) {
                //        $("#EditteacherName").empty();
                //        for (var i = 0; i < teachersName.length; i++) {
                //            if (i == Question.TeacherId) {
                //                $("#EditteacherName").append("<option value='" + teachersName[i].Id + "' selected='selected'>" + teachersName[i].TeacherName + "</option>");
                //            } else {
                //                $("#EditteacherName").append("<option value='" + teachersName[i].Id + "'>" + teachersName[i].TeacherName + "</option>");
                //            }

                //        }
                //    }
                //});

                //学校变更时班级信息变更
                $("#EditSchool").change(function () {
                    var schoolId = $("#EditSchool").val();
                    $.ajax({
                        async: false,
                        url: "/Student/GetClass?SchoolId = ",
                        data: { schoolId: schoolId },
                        type: "POST",
                        dataType: "JSON",
                        success: function (tempClass) {
                            $("#EditclassName").empty();
                            for (var i = 0; i < tempClass.length; i++) {
                                $("#EditclassName").append("<option value='" + tempClass[i].Id + "'>" + tempClass[i].ClassName + "</option>")
                            }
                        }
                    });
                });
                //学校变更时老师信息变更
                //$("#EditSchool").change(function () {
                //    var schoolId = $("#EditSchool").val();
                //    $.ajax({
                //        async: false,
                //        url: "/Question/GetTeacher?SchoolId = ",
                //        data: { schoolId: schoolId },
                //        type: "POST",
                //        dataType: "JSON",
                //        success: function (tempClass) {
                //            $("#EditteacherName").empty();
                //            for (var i = 0; i < tempClass.length; i++) {
                //                $("#EditteacherName").append("<option value='" + tempClass[i].Id + "'>" + tempClass[i].TeacherName + "</option>")
                //            }
                //        }
                //    });
                //});


            },
            error: function () {
                alert("获取修改信息失败");
            }

        });

    }

    $('#EditSubmit').click(function () {
     
        var questionValue = {
                 Id: $("#EditId").val(),

                EditQuestionnaireName: $("#EditQuestionnaireName").val(),
                EditStartTime: $("#EditStartTime").val(),
                EditEndTime: $("#EditEndTime").val(),
                EditSchool: $("#EditSchool").val(),
               // EditteacherName: $("#EditteacherName").val(),
                EditclassName: $("#EditclassName").val(),

        };
        $.ajax({
            type: "POST",
            url: "/Question/saveEditNaireQuestion",
            data: questionValue,
            success: function (msg) {
                alert("修改成功！");
                $('#EditModal').map(function () {
                    if (!$(this).is(":hidden")) {
                        $(this).modal('hide');
                    }
                });
                $("#QuestionList").bootstrapTable('refresh');
            },
           error:function(msg) {
               alert("修改失败：" + msg);
           }
        });
    });


    </script>



}
